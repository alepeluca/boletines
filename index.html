<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador: Boletines Municipales de Quilmes</title>
  <script src="flexsearch.compact.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    input { width: 100%; padding: 10px; margin-bottom: 20px; font-size: 16px; }
    .result { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .archivo a { font-weight: bold; text-decoration: none; color: #003366; }
  </style>
</head>
<body>
  <h1>Buscador: Boletines Municipales de Quilmes</h1>
  <input type="text" id="searchInput" placeholder="Buscar palabra o frase...">
  <div id="results"></div>

  <script>
    const search = new FlexSearch.Document({
      document: { id: "id", index: ["fragmento"], store: ["archivo", "fragmento"] },
    });

    let documentos = [];
    let resultados = [];

    function obtenerFechaBonita(fechaStr) {
      const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
      const año = fechaStr.slice(0, 4);
      const mes = parseInt(fechaStr.slice(4, 6)) - 1;
      return `${meses[mes]} de ${año}`;
    }

    function obtenerBoletinInfo(nombreArchivo) {
      const match = nombreArchivo.match(/(\d{8}) - boletin-(\d+)\.pdf/);
      if (match) {
        const fecha = match[1];
        const numero = match[2];
        return {
          numero: numero,
          fechaLegible: obtenerFechaBonita(fecha),
          nombre: `Boletín N.º ${numero} – ${obtenerFechaBonita(fecha)}`,
          link: `pdfs/${match[0]}`
        };
      } else {
        return {
          nombre: nombreArchivo,
          link: `pdfs/${nombreArchivo}`
        };
      }
    }

    async function cargarChunks() {
      for (let i = 1; i <= 16; i++) {
        const res = await fetch(`json_chunks/boletines_part_${i}.jsonl`);
        const text = await res.text();
        const lineas = text.split("\n").filter(Boolean);
        for (const linea of lineas) {
          const doc = JSON.parse(linea);
          documentos.push(doc);
          search.add(doc);
        }
      }
    }

    async function iniciarBuscador() {
      await cargarChunks();

      document.getElementById("searchInput").addEventListener("input", (e) => {
        const query = e.target.value.trim();
        resultados = [];
        document.getElementById("results").innerHTML = "";

        if (query.length < 2) return;

        const encontrados = search.search(query, { enrich: true });

        const ids = new Set();
        for (const grupo of encontrados) {
          for (const r of grupo.result) {
            if (!ids.has(r.id)) {
              ids.add(r.id);
              resultados.push(documentos.find(d => d.id === r.id));
            }
          }
        }

        renderResultados();
      });
    }

    function renderResultados() {
      const container = document.getElementById("results");
      container.innerHTML = `<p><strong>${resultados.length}</strong> resultados encontrados.</p>`;
      for (const r of resultados) {
        const pdfName = r.archivo.replace(".txt", ".pdf");
        const info = obtenerBoletinInfo(pdfName);
        container.innerHTML += `
          <div class="result">
            <div class="archivo"><a href="${info.link}" target="_blank">${info.nombre}</a></div>
            <p>${r.fragmento}</p>
          </div>`;
      }
    }

    iniciarBuscador();
  </script>
</body>
</html>
