<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador: Boletines Municipales de Quilmes</title>
  <script src="flexsearch.compact.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; max-width: 900px; background: #f0f0f0; }
    input, select, input[type="month"], button { padding: .5rem; font-size: 1rem; }
    input[type="month"] { width: 140px; }
    #progressBar { width: 100%; height: 1.2rem; margin: 1rem 0; }
    #status { font-style: italic; margin-bottom: .5rem; }
    #contador { font-weight:bold; margin-bottom:1rem; }
    #resultados, #visor { background: #fff; border: 2px solid #ccc; border-radius: 6px; padding:1rem; margin-bottom:1rem; }
    .resultado { padding: .8rem; margin: .5rem 0; border-radius: 4px; cursor: pointer; }
    .resultado:hover, .resultado.selected { background: #e6f0ff; }
    .linea { font-weight: bold; margin-bottom: .3rem; }
    .fragmento { white-space: pre-wrap; }
    #visor { height: 600px; overflow: hidden; }
    #visor iframe { width: 100%; height: 100%; border: none; }
    .opcion { margin-right: 1rem; }
    .opcion input { margin-right: .3rem; }
  </style>
</head>
<body>
  <h1>Buscador: Boletines Municipales de Quilmes</h1>

  <!-- Opciones de tipo de búsqueda -->
  <div id="opcionesBusqueda" style="margin-bottom:1rem;">
    <label class="opcion"><input type="radio" name="tipoBusqueda" value="contiene" checked> Contiene</label>
    <label class="opcion"><input type="radio" name="tipoBusqueda" value="empieza"> Empieza por</label>
    <label class="opcion"><input type="radio" name="tipoBusqueda" value="termina"> Termina en</label>
    <label class="opcion"><input type="radio" name="tipoBusqueda" value="una_o_otra"> Una u otra</label>
  </div>

  <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
    <input id="busqueda" placeholder="Escribí una palabra…" style="flex:1" />
    <select id="orden">
      <option value="desc">Más nuevos primero</option>
      <option value="asc">Más antiguos primero</option>
    </select>
    <button id="botonBuscar">Buscar</button>
  </div>

  <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
    <label>Desde: <input type="month" id="desde" /></label>
    <label>Hasta: <input type="month" id="hasta" /></label>
  </div>

  <progress id="progressBar" max="1" value="0"></progress>
  <div id="status"></div>
  <div id="contador"></div>

  <div id="resultados"><!-- Lista de resultados --></div>
  <div id="visor"><!-- Visor PDF --></div>

  <script>
    const progressBar = document.getElementById('progressBar');
    const statusDiv = document.getElementById('status');
    const resultadosDiv = document.getElementById('resultados');
    const input = document.getElementById('busqueda');
    const contador = document.getElementById('contador');
    const botonBuscar = document.getElementById('botonBuscar');
    const visor = document.getElementById('visor');

    function escapeRegex(str) {
      return str.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
    }

    async function detectChunks() {
      let count = 0;
      while (true) {
        try {
          const res = await fetch(`json_chunks/boletines_part_${count+1}.jsonl`, { method: 'HEAD' });
          if (!res.ok) break;
          count++;
        } catch { break; }
      }
      return count;
    }

    async function realizarBusqueda() {
      const q = input.value.trim();
      if (!q) return;

      botonBuscar.disabled = true;
      statusDiv.textContent = 'Buscando…';
      resultadosDiv.innerHTML = '';
      contador.textContent = '';
      progressBar.value = 0;
      visor.innerHTML = '';

      const totalChunks = await detectChunks();
      progressBar.max = totalChunks || 1;

      // Determinar regex según opción
      const tipo = document.querySelector('input[name="tipoBusqueda"]:checked').value;
      let pattern;
      if (tipo === 'empieza') pattern = '^' + escapeRegex(q);
      else if (tipo === 'termina') pattern = escapeRegex(q) + '$';
      else if (tipo === 'una_o_otra') {
        const parts = q.split(/\s+/).map(escapeRegex);
        pattern = parts.join('|');
      } else {
        pattern = escapeRegex(q);
      }

      let regex;
      try { regex = new RegExp(pattern, 'i'); }
      catch { statusDiv.textContent = ''; botonBuscar.disabled = false; resultadosDiv.innerHTML = '<p>Error en la expresión de búsqueda.</p>'; return; }

      let matches = [];
      for (let i = 1; i <= totalChunks; i++) {
        try {
          const text = await (await fetch(`json_chunks/boletines_part_${i}.jsonl`)).text();
          for (let ln of text.split(/\r?\n/)) {
            if (!ln) continue;
            let obj;
            try { obj = JSON.parse(ln); } catch { continue; }
            if (regex.test(obj.fragmento)) matches.push(obj);
          }
        } catch (e) { console.error('Error chunk', i, e); }
        progressBar.value = i;
      }

      statusDiv.textContent = '';
      botonBuscar.disabled = false;

      // Filtrar por fechas
      const desde = document.getElementById('desde').value;
      const hasta = document.getElementById('hasta').value;
      const norm = v => v.replace(/-/g,'') + '01';
      matches = matches.filter(m => {
        const f = m.archivo.substring(0,8);
        if (desde && f < norm(desde)) return false;
        if (hasta && f > norm(hasta)) return false;
        return true;
      });

      // Ordenar
      const orden = document.getElementById('orden').value;
      matches.sort((a,b) => {
        const fa = a.archivo.substring(0,8), fb = b.archivo.substring(0,8);
        return orden==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
      });

      if (!matches.length) {
        resultadosDiv.innerHTML = '<p>No se encontraron resultados.</p>';
        contador.textContent = '0 resultados encontrados.';
        return;
      }
      contador.textContent = `${matches.length} resultado${matches.length>1?'s':''} encontrado${matches.length>1?'s':''}.`;

      const meses = { '01':'enero','02':'febrero','03':'marzo','04':'abril', '05':'mayo','06':'junio','07':'julio','08':'agosto','09':'septiembre','10':'octubre','11':'noviembre','12':'diciembre' };

      // Mostrar resultados
      matches.forEach((m, idx) => {
        const fecha = m.archivo.substring(0,8);
        const anio = fecha.slice(0,4);
        const mesNombre = meses[fecha.slice(4,6)] || fecha.slice(4,6);
        const num = (m.archivo.match(/boletin-(\d+)/i)||[])[1]||'';
        const texto = `Boletín Oficial Municipal N.º ${num} – ${mesNombre} de ${anio}`;
        const page = m.pagina || 1;
        const urlPDF = `https://quilmes.gov.ar/pdf/boletines/boletin-${num}.pdf`;

        const div = document.createElement('div');
        div.className = 'resultado';
        div.innerHTML = `<div class="linea">${texto}</div><div class="fragmento">${m.fragmento.replace(regex, '<mark>$&</mark>')}</div>`;
        div.addEventListener('click', () => {
          // marcar seleccionado
          document.querySelectorAll('.resultado').forEach(el => el.classList.remove('selected'));
          div.classList.add('selected');
          // mostrar PDF
          visor.innerHTML = `<iframe src="${urlPDF}#page=${page}" allowfullscreen></iframe>`;
        });
        resultadosDiv.appendChild(div);
      });
    }

    input.addEventListener('keydown', e => { if (e.key === 'Enter') realizarBusqueda(); });
    botonBuscar.addEventListener('click', realizarBusqueda);
  </script>
</body>
</html>
